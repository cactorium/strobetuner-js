<!doctype html5>
<html>
  <head>
    <title>HTML5 Strobe Tuner</title>
    <script src=strobe.js type=text/javascript></script>
  <script type=text/javascript>
'use strict'
var canvas = null
var active = null

var audioCtx = null
var microphoneNode = null
var gainNode = null
var strobe = null

var glCtx = null

function lin2db(x) {
  return 10*Math.log10(x)
}

function db2lin(x) {
  return Math.pow(10, 0.1*x)
}



window.onload = function() {
  canvas = document.getElementById('strobe')
  active = document.getElementById('strobe-active')

  glCtx = canvas.getContext('webgl')

  audioCtx = new AudioContext()
  microphoneNode = null
  gainNode = audioCtx.createGain()
  strobe = new StrobeTuner(audioCtx, glCtx)

  var getMicrophone = function(cb) {
    navigator.mediaDevices.getUserMedia({audio: true}).
      then(function(stream) {
        microphoneNode = audioCtx.createMediaStreamSource(stream)

          if (cb !== null) {
          cb()
        }
      }).
      catch(function(err) {
        console.log('error on getting microphone: ' + err)
        // TODO log message on UI
      })
  }
  var connectMicrophone = function() {
      microphoneNode.connect(gainNode)
      gainNode.connect(strobe.audioNode)
      strobe.audioNode.connect(audioCtx.destination)
  }
  var disconnectMicrophone = function() {
    if (microphoneNode !== null) {
      microphoneNode.disconnect()
    }
    if (strobe !== null && strobe.audioNode !== null) {
      strobe.audioNode.disconnect()
    }
  }

  var runDraw = false
  var drawId = null
  var draw = function() {
    // console.log('draw loop')
    if (runDraw) {
      if (strobe !== null) {
        strobe.drawStrobe()
      }
      drawId = window.requestAnimationFrame(draw)
    }
  }

  var startDrawloop = function() {
    runDraw = true
    drawId = window.requestAnimationFrame(draw)
  }

  var stopDrawloop = function() {
    runDraw = false
    if (drawId !== null) {
      window.cancelAnimationFrame(drawId)
    }
    drawId = null
    strobe.resetDraw()
  }

  active.addEventListener('change', function() {
    if (active.checked) {
      if (microphoneNode !== null) {
        connectMicrophone()
        startDrawloop()
      } else {
        getMicrophone(function() {
          connectMicrophone()
          startDrawloop()
        })
      }
    } else {
      disconnectMicrophone()
      stopDrawloop()
    }
  })

  var pitch = document.getElementById('strobe-pitch')
  var gain = document.getElementById('strobe-gain')
  var gainVal = document.getElementById('strobe-gain-val2')
  var bright = document.getElementById('strobe-bright')
  var brightVal = document.getElementById('strobe-bright-val')
  var contrast = document.getElementById('strobe-contrast')
  var contrastVal = document.getElementById('strobe-contrast-val')
  var autoGain = document.getElementById('strobe-agc')

  // initialize all values based on StrobeTuner default values
  pitch.value = 440
  gain.value = lin2db(gainNode.gain.value)
  gainVal.textContent = lin2db(gainNode.gain.value).toString()
  bright.value = strobe.brightOffset
  brightVal.textContent = strobe.brightOffset.toString()
  contrast.value = strobe.brightGain
  contrastVal.textContent = strobe.brightGain.toString()

  gain.addEventListener('input', function() {
    document.getElementById('strobe-gain-val').textContext = gainNode.gain.value;
    gainNode.gain.value = db2lin(gain.value);
    console.log(gainVal, gain.value, gainNode.gain.value, gainVal.textContent);
  })
  bright.addEventListener('input', function() {
    strobe.brightOffset = bright.value
    brightVal.textContent = bright.value.toString()
  })
  contrast.addEventListener('input', function() {
    strobe.brightGain = contrast.value
    contrastVal.textContent = contrast.value.toString()
  })
  autoGain.addEventListener('change', function() {
    strobe.autoGain = autoGain.checked
  })

}
  </script>
  </head>
  <body>
    <canvas id=strobe width=128 height=256>
      Sorry, your browser needs to support canvas to use this webpage
    </canvas>
    <div id=strobe-ui>
      <noscript>Javascript needs to be enabled to use this webpage</noscript>
      <input id=strobe-active type=checkbox>Activate strobe tuner</input> <br />
      A4 = <input id=strobe-pitch type=number value=440></input> Hz<br />
      Gain: <input id=strobe-gain type=range min=-10 max=20 step=0.01></input>
      <span id=strobe-gain-val></span>
      <input id=strobe-agc type=checkbox checked>AGC</input><br />
      Brightness: <input id=strobe-bright type=range min=-1 max=1 step=0.01></input>
      <span id=strobe-bright-val></span><br />
      Contrast: <input id=strobe-contrast type=range min=0 max=1000 step=0.01></input>
      <span id=strobe-contrast-val></span><br />
      <span id=strobe-gain-val2></span><br />
    </div>
  </body>
</html>
