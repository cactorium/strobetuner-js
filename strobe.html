<!doctype html5>
<html>
  <head>
    <title>HTML5 Strobe Tuner</title>
    <script src=strobe.js type=text/javascript></script>
  <script type=text/javascript>
'use strict'
var canvas = null
var active = null

var audioCtx = null
var microphoneNode = null
var gainNode = null
var strobe = null

var glCtx = null


window.onload = function() {
  canvas = document.getElementById('strobe')
  active = document.getElementById('strobe-active')

  glCtx = canvas.getContext('webgl')

  audioCtx = new AudioContext()
  microphoneNode = null
  gainNode = null
  strobe = new StrobeTuner(audioCtx, glCtx)

  var getMicrophone = function(cb) {
    navigator.mediaDevices.getUserMedia({audio: true}).
      then(function(stream) {
        microphoneNode = audioCtx.createMediaStreamSource(stream)
        gainNode = audioCtx.createGain()

          if (cb !== null) {
          cb()
        }
      }).
      catch(function(err) {
        console.log('error on getting microphone: ' + err)
        // TODO log message on UI
      })
  }
  var connectMicrophone = function() {
      microphoneNode.connect(gainNode)
      gainNode.connect(strobe.audioNode)
      strobe.audioNode.connect(audioCtx.destination)
  }
  var disconnectMicrophone = function() {
    if (microphoneNode !== null) {
      microphoneNode.disconnect()
    }
    if (gainNode !== null) {
      gainNode.disconnect()
    }
    if (strobe !== null && strobe.audioNode !== null) {
      strobe.audioNode.disconnect()
    }
  }

  var runDraw = false
  var drawId = null
  var draw = function() {
    // console.log('draw loop')
    if (runDraw) {
      if (strobe !== null) {
        strobe.drawStrobe()
      }
      drawId = window.requestAnimationFrame(draw)
    }
  }

  var startDrawloop = function() {
    runDraw = true
    drawId = window.requestAnimationFrame(draw)
  }

  var stopDrawloop = function() {
    runDraw = false
    if (drawId !== null) {
      window.cancelAnimationFrame(drawId)
    }
    drawId = null
  }

  active.addEventListener('change', function() {
    if (active.checked) {
      if (microphoneNode !== null && gainNode !== null) {
        connectMicrophone()
        startDrawloop()
      } else {
        getMicrophone(function() {
          connectMicrophone()
          startDrawloop()
        })
      }
    } else {
      disconnectMicrophone()
      stopDrawloop()
    }
  })
}
  </script>
  </head>
  <body>
    <canvas id=strobe width=128 height=128>
      Sorry, your browser needs to support canvas to use this webpage
    </canvas>
    <div id=strobe-ui>
      <noscript>Javascript needs to be enabled to use this webpage</noscript>
      <input id=strobe-active type=checkbox>Activate strobe tuner</input>
    </div>
  </body>
</html>
